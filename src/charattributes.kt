import CharAttribute.Companion.NOFLAGS
import CharAttribute.Companion.PRINTBIT
import CharAttribute.Companion.SPACEBIT

@JvmInline
value class CharAttribute(val bits:Int)
{
	val isAlpha get () = ALPHABIT in bits
	val isAlNum get () = ALNUM in bits
	val isDigit get () = DIGITBIT in bits
	val isSpace get () = SPACEBIT in bits
	val isPrintable get () = PRINTBIT in bits
	val isHexDigit  get () = XDIGITBIT in bits

	companion object
	{
		private var bp = 0
		private fun flag () = 1 shl (bp++)

		private operator fun Int.contains (bit:Int)
			= (this and bit) != 0
		
		internal val NOFLAGS = 0
		internal val ALPHABIT = flag()
		internal val DIGITBIT = flag()
		internal val PRINTBIT = flag()
		internal val SPACEBIT = flag()
		internal val XDIGITBIT = flag()
		internal val ALNUM = ALPHABIT or DIGITBIT

		val Non = CharAttribute(0)

		operator fun invoke (ch:Char?) = ch?.let { TABLE.getOrNull(ch.code) } ?: Non
	}
}

//* accept (U)ni(C)ode (ID)entifiers?
const val LUA_UCID = 0
val NONASCI = when (LUA_UCID) {
	// consider all non-ascii codepoints to be alphabetic
	1 -> 0b00001

	// default
	else -> NOFLAGS
}

val TABLE = intArrayOf(
	// 00
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	SPACEBIT,
	SPACEBIT,
	SPACEBIT,
	SPACEBIT,
	SPACEBIT,
	NOFLAGS,
	NOFLAGS,
	// 10
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	// 20
	0b01100,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	// 30
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	0b10110,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	// 40
	PRINTBIT,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	// 50
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	0b00101,
	// 60
	PRINTBIT,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b10101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	// 70
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	0b00101,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	PRINTBIT,
	NOFLAGS,
	// 80
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// 90
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// a0
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// b0
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// c0
	NOFLAGS,
	NOFLAGS,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// d0
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// e0
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	// f0
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NONASCI,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
	NOFLAGS,
).map(::CharAttribute)

